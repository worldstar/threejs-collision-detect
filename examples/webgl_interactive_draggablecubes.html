<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - draggable cubes</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				font-family: Monospace;
				background-color: #f0f0f0;
				margin: 0px;
				overflow: hidden;
			}
		</style>
	</head>
	<body>

		<script src="../build/three.js"></script>
		<script src="js/loaders/DDSLoader.js"></script>
		<script src="js/loaders/KMZLoader.js"></script>
		<script src="js/loaders/ColladaLoader.js"></script>
		<script src="js/loaders/OBJLoader.js"></script>
		<script src="js/loaders/MTLLoader.js"></script>		
		<script src="js/controls/DragControls.js"></script>
		<script src="js/controls/TrackballControls.js"></script>
		<script src="js/controls/EventsControls.js"></script>
		<script src="js/libs/stats.min.js"></script>
		<script src="js/controls/OrbitControls.js"></script>	
		<script src="js/WebGL.js"></script>
		<script src="js/libs/jszip.min.js"></script>
		<script>

			var container, stats;
			var camera, controls, scene, renderer;
			var objects = [];
			var elf;
			var ground; // A square base on which the artifacts stand.

			init();
			animate();

			function addBasket(scene, geometry, objects){

			}

			function init() {

				container = document.createElement( 'div' );
				document.body.appendChild( container );

				camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, 5000 );
				camera.position.x = 0;
				camera.position.y = -750;
				camera.position.z = 700;
				camera.lookAt( 0, 0, 0 );

				controls = new THREE.TrackballControls( camera );
				controls.rotateSpeed = 1.0;
				controls.zoomSpeed = 1.2;
				controls.panSpeed = 0.8;
				controls.noZoom = false;
				controls.noPan = false;
				controls.staticMoving = true;
				controls.dynamicDampingFactor = 0.3;

				scene = new THREE.Scene();
				scene.background = new THREE.Color( 0xf0f0f0 );

				scene.add( new THREE.AmbientLight( 0x505050 ) );

				var light = new THREE.SpotLight( 0xffffff, 1.5 );
				light.position.set( 0, 500, 2000 );
				light.angle = Math.PI / 9;

				light.castShadow = true;
				light.shadow.camera.near = 1000;
				light.shadow.camera.far = 4000;
				light.shadow.mapSize.width = 1024;
				light.shadow.mapSize.height = 1024;

				scene.add( light );

				ground = new THREE.Mesh(
					new THREE.BoxGeometry(1600,950,1),
					new THREE.MeshLambertMaterial( {color:"grey", dashSize:3, linewidth:3})
				);
				ground.position.y = -10;  // top of base lies in the plane y = -5;
				scene.add(ground);			


				//Sample objects					
				var geometry = new THREE.BoxBufferGeometry( 40, 40, 40 );
				for ( var i = 0; i < 3; i ++ ) {
					var loader = new THREE.TextureLoader();
					// loader.setPath( 'models/TEST1OBJ/TEST1/' );

					var material = [
					    new THREE.MeshBasicMaterial( { map: loader.load("models/basket20050120182/material_2.jpg") } ),//右邊
					    new THREE.MeshBasicMaterial( { map: loader.load("models/basket20050120182/material_4.jpg") } ),//左邊
					    new THREE.MeshBasicMaterial( { map: loader.load("models/basket20050120182/material_3.jpg") } ),//背面
					    new THREE.MeshBasicMaterial( { map: loader.load("models/basket20050120182/__.jpg") } ),//正面
					    new THREE.MeshBasicMaterial( { map: loader.load("models/basket20050120182/material_1.jpg") } ),//上視圖
					    new THREE.MeshBasicMaterial( { map: loader.load("models/basket20050120182/material_5.jpg") } ),//底部
					];

					// var material = [
					//     new THREE.MeshBasicMaterial( { map: loader.load("models/TEST1OBJ/TEST2/_2.jpg") } ),//右邊
					//     new THREE.MeshBasicMaterial( { map: loader.load("models/TEST1OBJ/TEST2/_4.jpg") } ),//左邊
					//     new THREE.MeshBasicMaterial( { map: loader.load("models/TEST1OBJ/TEST2/_3.jpg") } ),//背面
					//     new THREE.MeshBasicMaterial( { map: loader.load("models/TEST1OBJ/TEST2/_.jpg") } ),//正面
					//     new THREE.MeshBasicMaterial( { map: loader.load("models/TEST1OBJ/TEST2/_1.jpg") } ),//上視圖
					//     new THREE.MeshBasicMaterial( { map: loader.load("models/TEST1OBJ/TEST2/_5.jpg") } ),//底部
					// ];					
					// var texture = new THREE.TextureLoader().load( 'models/TEST1OBJ/TEST1/_6.jpg' );
					// var material = new THREE.MeshFaceMaterial( { color: 0xffffff, envMap: textureCube } );		
					// var material = new THREE.MeshBasicMaterial( { map: texture } );			

					// var object = new THREE.Mesh( geometry, new THREE.MeshLambertMaterial( { color: Math.random() * 0xffffff } ) ); 
					var object = new THREE.Mesh( geometry, material ); 
					var height = object.geometry.parameters.height;

					object.rotation.x = 0;//Math.random() * 2 * Math.PI
					object.rotation.y = 0;
					object.rotation.z = 0;

					object.scale.x = Math.random() * 4 + 2;//Math.random() * 5 + 1
					object.scale.y = Math.random() * 4 + 2;
					object.scale.z = Math.random() * 4 + 2;

					object.position.x = Math.random() * 800 - 400;
					object.position.y = Math.random() * 500 - 300;
					object.position.z = 1.1*object.scale.z*height/2;					

					object.castShadow = true;
					object.receiveShadow = true;
					var helper = new THREE.Box3Helper( object, 0xffff00 );
					scene.add( object );
					objects.push( object );

				}		
						
					// var loader = new THREE.TextureLoader();
					// loader.setPath( 'models/TEST1OBJ/20050120182/' );

					// var material = [
					//     new THREE.MeshBasicMaterial( { map: loader.load("models/basket20050120182/material_2.jpg") } ),//右邊
					//     new THREE.MeshBasicMaterial( { map: loader.load("models/basket20050120182/material_4.jpg") } ),//左邊
					//     new THREE.MeshBasicMaterial( { map: loader.load("models/basket20050120182/material_3.jpg") } ),//背面
					//     new THREE.MeshBasicMaterial( { map: loader.load("models/basket20050120182/test.png") } ),//正面
					//     new THREE.MeshBasicMaterial( { map: loader.load("models/basket20050120182/material_1.jpg") } ),//上視圖
					//     new THREE.MeshBasicMaterial( { map: loader.load("models/basket20050120182/material_5.jpg") } ),//底部
					// ];

					// var object = new THREE.Mesh( geometry, material ); 
					// var height = object.geometry.parameters.height;

					// object.rotation.x = 0;//Math.random() * 2 * Math.PI
					// object.rotation.y = 0;
					// object.rotation.z = 0;

					// object.scale.x = Math.random() * 4 + 1;//Math.random() * 5 + 1
					// object.scale.y = Math.random() * 4 + 1;
					// object.scale.z = Math.random() * 4 + 1;

					// object.position.x = Math.random() * 800 - 400;
					// object.position.y = Math.random() * 500 - 300;
					// object.position.z = 1.1*object.scale.z*height/2;					

					// object.castShadow = true;
					// object.receiveShadow = true;
					// var helper = new THREE.Box3Helper( object, 0xffff00 );
					// scene.add( object );
					// objects.push( object );



				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );

				renderer.shadowMap.enabled = true;
				renderer.shadowMap.type = THREE.PCFShadowMap;
				container.appendChild( renderer.domElement );


				var info = document.createElement( 'div' );
				info.style.position = 'absolute';
				info.style.top = '100px';
				info.style.width = '100%';
				info.style.textAlign = 'center';
				info.innerHTML = '<a href="http://threejs.org" target="_blank" rel="noopener">three.js</a> webgl - draggable cubes';
				container.appendChild( info );

				stats = new Stats();
				container.appendChild( stats.dom );

				//
				window.addEventListener( 'resize', onWindowResize, false );
	

				// you may also want to add an mouse move event listener to render when moving objects
				renderer.domElement.addEventListener("mousemove", function(event) {
				    renderer.render(scene, camera);
				});						


				//Events EventsControls
				EventsControls2 = new EventsControls(camera, renderer.domElement);
				EventsControls2.map = ground;

				EventsControls2.attachEvent('mouseOver', function() {
				    this.container.style.cursor = 'pointer';
				});

				EventsControls2.attachEvent('mouseOut', function() {
				    this.container.style.cursor = 'auto';
				});

				EventsControls2.attachEvent('dragAndDrop', function() {
				    this.container.style.cursor = 'move';
				    this.focused.position.y = this.previous.y;
				});					


				// var loaderObj = new THREE.OBJLoader();

				// // load a resource
				// loaderObj.load(
				// 	// resource URL
				// 	'models/obj/male02/male02.obj',
				// 	// called when resource is loaded
				// 	function ( object ) {
				// 		object.scale.x = 2;
				// 		object.scale.y = 2;
				// 		object.scale.z = 2;
				// 		object.position.x = -100;	
				// 		object.rotation.x = 90;
				// 		scene.add( object );
				// 		EventsControls2.attach(object);	
				// 	},
				// 	// called when loading is in progresses
				// 	function ( xhr ) {
				// 		console.log( ( xhr.loaded / xhr.total * 100 ) + '% loaded' );
				// 	},
				// 	// called when loading has errors
				// 	function ( error ) {
				// 		console.log( 'An error happened' );
				// 	}
				// );			

				var onProgress = function ( xhr ) {

					if ( xhr.lengthComputable ) {

						var percentComplete = xhr.loaded / xhr.total * 100;
						console.log( Math.round( percentComplete, 2 ) + '% downloaded' );

					}

				};

				var onError = function () { };

				THREE.Loader.Handlers.add( /\.dds$/i, new THREE.DDSLoader() );

				// new THREE.MTLLoader()
				// 	.setPath( 'models/TestObjRedWoodCan/' )
				// 	.load( 'redWoodCan.mtl', function ( materials ) {

				// 		materials.preload();

				// 		new THREE.OBJLoader()
				// 			.setMaterials( materials )
				// 			.setPath( 'models/TestObjRedWoodCan/' )
				// 			.load( 'redWoodCan.obj', function ( object ) {
				// 				object.scale.x = 1;
				// 				object.scale.y = 1;
				// 				object.scale.z = 1;
				// 				object.position.y = -95;
				// 				object.position.y = 95;
				// 				object.position.z = 300;
				// 				scene.add( object );
				// 				EventsControls2.attach(object);	
				// 			}, onProgress, onError );
				// 	} );					


				// collada
				// var loader = new THREE.ColladaLoader( );
				// loader.options.convertUpAxis = true;
				// EventsControls2.offsetUse = true;
				// // ./models/TEST1DAE/test3.dae
				// loader.load( './models/Test2/Test2.dae', function ( collada ) {
				// 	elf = collada.scene;
				// 	// var height = elf.geometry.vertices[4].y-elf.geometry.vertices[0].y;
				// 	var cube_bbox = new THREE.Box3();
				// 	cube_bbox.setFromObject( elf );
				// 	var height = cube_bbox.max.y - cube_bbox.min.y;
				// 	// var height = elf.geometry.parameters.height;
				// 	elf.position.z = height/2;					
				// 	elf.scale.x = 10;
				// 	elf.scale.y = 10;
				// 	elf.scale.z = 10;
				// 	elf.rotation.x = 0;
				// 	elf.updateMatrix();
				// 	scene.add( elf );
				// 	objects.push( elf );
				// 	EventsControls2.attach(elf);			
				// } );				

				//KMZ file
				// var loaderKMZ = new THREE.KMZLoader();
				// loaderKMZ.load( './models/kmz.kmz', function ( kmz ) {
				// 	elf = kmz.scene;
				// 	var cube_bbox = new THREE.Box3();
				// 	cube_bbox.setFromObject( elf );
				// 	var height = cube_bbox.max.y - cube_bbox.min.y;

				// 	elf.position.y = 500;
				// 	elf.position.z = height/2;		
				// 	scene.add( elf );
				// 	objects.push( elf );
				// 	EventsControls2.attach(elf);	
				// 	render();
				// } );				

				// var controlsKMZ = new THREE.OrbitControls( camera, renderer.domElement );
				// controlsKMZ.addEventListener( 'change', render );
				// controlsKMZ.update();

				// window.addEventListener( 'resize', onWindowResize, false );			

				//Start to drag
				var dragControls = new THREE.DragControls( objects, camera, renderer.domElement );
				dragControls.addEventListener( 'dragstart', function (event) {
					controls.enabled = false;
				} );

				dragControls.addEventListener( 'dragend', function (event) {
					var height = object.geometry.parameters.height;
					event.object.position.x = Math.min(700,Math.max(-700,event.object.position.x));
					event.object.position.y = Math.min(400,Math.max(-400,event.object.position.y));
					event.object.position.z = 1.1*object.scale.z*height/2
					info.innerHTML = "X: "+event.object.position.x+", Y:"+event.object.position.y+", Z:"+event.object.position.z;
					controls.enabled = true;
				} );										
			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			//

			function animate() {
				requestAnimationFrame( animate );
				render();
				stats.update();

			}

			function render() {
				controls.update();
				renderer.render( scene, camera );

			}

		</script>

	</body>
</html>
